<!DOCTYPE html>
<html>


<head>
    <meta charset="utf-8">
    <!-- Nous chargeons les fichiers CDN de Leaflet. Le CSS AVANT le JS -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
        integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
        crossorigin="" />
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/1.11.8/semantic.min.css" />
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="script.js"></script>
    <script src="affichage.js"></script>
    <style type="text/css">
        #map {
            height: 75vh;
        }

        #cont {
            height: auto;
        }
    </style>
    <title>Carte</title>

</head>

<body>

    <div class="ui raised very padded text container segment" id="cont">
        <div class="ui segment">
            <h2 class="ui left floated header">Carte de la ville</h2>
            <div class="ui clearing divider"></div>
            <div class="ui segment" id="map">
                <!-- Ici s'affichera la carte -->
            </div>
            <button class="ui icon right floated button" id="expand">
                <i class="expand icon"></i>
                <button class="ui icon right floated button" id="close">
                    <i class="close icon"></i>
                    <button class="ui toggle labeled icon active button btn" id="monument">
                        <i class="building icon"></i> Monuments
                    </button>
                    <button class="ui toggle labeled icon active button btn" id="restaurant">
                        <i class="coffee icon"></i> Restaurants
                    </button>
        </div>
    </div>

    <!-- Fichiers Javascript -->
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
        integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
        crossorigin=""></script>
    <script type="text/javascript">

        function setID(map) {
            var cpt = 1;
            for (const key of map.keys()) {
                if (key != cpt) {
                    return cpt;
                } else {
                    cpt++;
                }
            }
            return cpt;;
        }

        var pseudo = prompt("Entrez votre pseudo");
        var id;
        //--------------------------------------------------------------------------------------------
        //on recupere les données stockées dans le navigateur et on les tri dans des tableaux
        var tabDataMonument = localStorage.getItem("tabDataMonument");
        var tabDataMonument = tabDataMonument.split("|");
        tabDataMonument.pop();//on retire le dernier element ca vide
        for (var i = 0; i < tabDataMonument.length; i++) {
            tabDataMonument[i] = tabDataMonument[i].split(";");
            //console.log(tabDataMonument[i]);
        }
        console.log(tabDataMonument);

        //----------------------------------------------------------------------------------------
        //on va recuperer les utilisateurs deja connectés sur la map
        var tabUsers = localStorage.getItem("tabUsers");
        var tabUsers = tabUsers.split("|");
        tabUsers.pop();//on retire le dernier element car vide
        var dictUsers = new Map();
        for (var i = 0; i < tabUsers.length; i++) {
            tabUsers[i] = tabUsers[i].split(";");
            //console.log(tabDataMonument[i]);

            dictUsers.set(tabUsers[i][0], [tabUsers[i][1], tabUsers[i][2], tabUsers[i][3]]);
        }

        //console.log(tabUsers);
        console.log(dictUsers);
        id = setID(dictUsers);
        //------------------------------------------------

        // On initialise la latitude et la longitude de Albi (centre de la carte)
        var lat = 43.925338;
        var lon = 2.148530;
        var macarte = null;
        // Fonction d'initialisation de la carte
        function initMap() {
            //----------------------
            // Créer l'objet "macarte" et l'insèrer dans l'élément HTML qui a l'ID "map"
            macarte = L.map('map').setView([lat, lon], 15);
            // Nous ajoutons le marquer de position

            // Nous ajoutons les marqeurs des monuments
            var iconBase = "images/monument_pin.png";
            //initialisation du nouvel icon pour les monuments
            var myIcon = L.icon({
                iconUrl: iconBase,
                iconSize: [50, 50],
                iconAnchor: [25, 50],
                popupAnchor: [-3, -76],
            });

            //on place les marqueurs avec le bon icon
            for (var i = 0; i < tabDataMonument.length; i++) {
                var longM = tabDataMonument[i][1];
                var latM = tabDataMonument[i][2];
                var marker = L.marker([latM, longM], { icon: myIcon }).addTo(macarte);
                marker.bindPopup(tabDataMonument[i][0]);
            }
            //var marker = L.marker([lat, lon]).addTo(macarte);

            // Leaflet ne récupère pas les cartes (tiles) sur un serveur par défaut. Nous devons lui préciser où nous souhaitons les récupérer. Ici, openstreetmap.fr
            L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', {
                // Il est toujours bien de laisser le lien vers la source des données
                attribution: 'données © <a href="//osm.org/copyright">OpenStreetMap</a>/ODbL - rendu <a href="//openstreetmap.fr">OSM France</a>',
                minZoom: 14,
                maxZoom: 20
            }).addTo(macarte);

        };





        window.onload = function () {
            // Fonction d'initialisation qui s'exécute lorsque le DOM est chargé
            initMap();
            //test geoloc
            if (!navigator.geolocation) {
                alert("Votre navigateur ne prends pas en charge la geolocalisation")
            }
            else {
                /*
                setInterval(()=>{
                     
                    navigator.geolocation.getCurrentPosition(getPosition,showError,options);
                },1000);
                */

                navigator.geolocation.watchPosition(getPosition);


            }

            var listeMarker = [];
            var marker, circle;
            function getPosition(position) {


                var iconPosition = "images/position.png";
                //initialisation du nouvel icon pour les monuments
                var myIconP = L.icon({
                    iconUrl: iconPosition,
                    iconSize: [50, 50],
                    iconAnchor: [25, 50],
                    popupAnchor: [-3, -76],
                });

                //console.log(position);
                var latU = position.coords.latitude;
                var longU = position.coords.longitude;
                var accuracy = position.coords.accuracy;


                /*
                ici on va s'occuper d'updater la position de l'utilisateur dans la BDD
                */
                $.ajax({
                    url: 'updatePos.php',
                    type: 'POST',
                    data: {
                        id: id,
                        pseudo: pseudo,
                        long: longU,
                        lat: latU
                    },
                    dataType: 'text',
                    success: function (resultat, statut) {
                        if (resultat != "") alert(resultat); //erreur dans la requete sql
                        else {
                            console.log("données utilisateur mise a jour")
                            if (marker) {
                                macarte.removeLayer(marker);
                            }
                            if (circle) {
                                macarte.removeLayer(circle);
                            }

                            if (accuracy < 100) {
                                marker = L.marker([latU, longU], { icon: myIconP }).addTo(macarte);
                                circle = L.circle([latU, longU], { radius: accuracy });
                                //macarte.fitBounds(marker.getBounds());
                            }
                            else {
                                marker = L.marker([latU, longU], { icon: myIconP });
                                circle = L.circle([latU, longU], { radius: accuracy });

                                featureGroup = L.featureGroup([marker, circle]).addTo(macarte);

                                macarte.fitBounds(featureGroup.getBounds());
                            }

                            console.log("lat: " + latU + "\nlong: " + longU + "\nprecision: " + accuracy);
                        }
                        //mise a jour des autres users
                        $.ajax({
                            url: 'getUsers.php',
                            type: 'GET',
                            data: false,
                            dataType: 'text',
                            success: function (data2, statut) {
                                var toDraw = data2.split("|");
                                toDraw.pop();//on retire le dernier element ca vide
                                for (var i = 0; i < toDraw.length; i++) {
                                    toDraw[i] = toDraw[i].split(";");
                                    //console.log(tabDataMonument[i]);
                                }
                                console.log(toDraw);

                                //parcours de toDraw pour supprimer moi
                                var index;
                                for (var i = 0; i < toDraw.length; i++) {
                                    if (toDraw[i][0] == id) {
                                        index = i;

                                    }
                                }
                                toDraw.splice(index, 1);


                                if (listeMarker) {
                                    for (var i = 0; i < listeMarker.length; i++) {
                                        console.log("je remove");
                                        macarte.removeLayer(listeMarker[i]);
                                    }
                                }


                                for (var i = 0; i < toDraw.length; i++) {
                                    console.log("id: " + toDraw[i][0]);

                                    var marker1 = L.marker([toDraw[i][3], toDraw[i][2]], { icon: myIconP }).addTo(macarte);
                                    marker1.bindPopup(toDraw[i][1]);
                                    listeMarker.push(marker1);

                                }


                            },
                            // erreur dans la requête http
                            error: function (resultat, statut, erreur) {
                                console.log(resultat);
                                alert(erreur);
                            }
                        });

                    },
                    //erreur dans la requete http
                    error: function (resultat, statut, erreur) {
                        console.log(resultat);
                        alert(erreur);
                    }
                });


            }

        };

    </script>
</body>

</html>