<!DOCTYPE html>
<html>

    
    <head>
        <meta charset="utf-8">
        <!-- Nous chargeons les fichiers CDN de Leaflet. Le CSS AVANT le JS -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ==" crossorigin="" />
        <script src="script.js"></script>
        <style type="text/css">
            #map{ /* la carte DOIT avoir une hauteur sinon elle n'apparaît pas */
                height:400px;
            }
        </style>
        <title>Cartes</title>

    </head>
    <body>

            
        
        
        <div id="map">
	    <!-- Ici s'affichera la carte -->
	</div>

        <!-- Fichiers Javascript -->
        <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw==" crossorigin=""></script>
	<script type="text/javascript">
            //on recupere les données stockées dans le navigateur et on les tri dans des tableaux
            var tabDataMonument = localStorage.getItem("tabDataMonument");
            var tabDataMonument = tabDataMonument.split("|");
            tabDataMonument.pop();//on retire le dernier element ca vide
            for(var i=0; i<tabDataMonument.length; i++){
                tabDataMonument[i] = tabDataMonument[i].split(";");
                //console.log(tabDataMonument[i]);
            }
            console.log(tabDataMonument);



            // On initialise la latitude et la longitude de Albi (centre de la carte)
            var lat = 43.925338;
            var lon = 2.148530;
            var macarte = null;
            // Fonction d'initialisation de la carte
            function initMap() {
                //----------------------
                // Créer l'objet "macarte" et l'insèrer dans l'élément HTML qui a l'ID "map"
                 macarte = L.map('map').setView([lat, lon], 15);
                 // Nous ajoutons le marquer de position
                
                  // Nous ajoutons les marqeurs des monuments
                var iconBase = "images/monument_pin.png";
                //initialisation du nouvel icon pour les monuments
                var myIcon = L.icon({
                    iconUrl: iconBase,
                    iconSize: [50, 50],
                    iconAnchor: [25, 50],
                    popupAnchor: [-3, -76],
                });

                        //on place les marqueurs avec le bon icon
                for(var i = 0; i<tabDataMonument.length; i++){
                    var longM = tabDataMonument[i][1];
                    var latM = tabDataMonument[i][2];
                    var marker = L.marker([latM, longM], { icon: myIcon }).addTo(macarte);
                    marker.bindPopup(tabDataMonument[i][0]);
                    }
                        //var marker = L.marker([lat, lon]).addTo(macarte);

                        // Leaflet ne récupère pas les cartes (tiles) sur un serveur par défaut. Nous devons lui préciser où nous souhaitons les récupérer. Ici, openstreetmap.fr
                    L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', {
                            // Il est toujours bien de laisser le lien vers la source des données
                        attribution: 'données © <a href="//osm.org/copyright">OpenStreetMap</a>/ODbL - rendu <a href="//openstreetmap.fr">OSM France</a>',
                        minZoom: 14,
                        maxZoom: 20
                    }).addTo(macarte);
                       
            };        
                   
                    
                

    
            window.onload = function(){
		    // Fonction d'initialisation qui s'exécute lorsque le DOM est chargé
		    initMap(); 
            //test geoloc
            if(!navigator.geolocation){
                alert("Votre navigateur ne prends pas en charge la geolocalisation")
            }
            else{
                /*
                setInterval(()=>{
                     
                    navigator.geolocation.getCurrentPosition(getPosition,showError,options);
                },1000);
                */
                navigator.geolocation.watchPosition(getPosition);
                
            }
            

            var marker, circle;
            function getPosition(position){
                //console.log(position);
                var latU = position.coords.latitude;
                var longU = position.coords.longitude;
                var accuracy = position.coords.accuracy;

                if(marker){
                    macarte.removeLayer(marker);
                }
                if(circle){
                    macarte.removeLayer(circle);
                }

                marker = L.marker([latU,longU]);
                circle = L.circle([latU,longU], {radius: accuracy});

                var featureGroup = L.featureGroup([marker, circle]).addTo(macarte);

                macarte.fitBounds(featureGroup.getBounds());

                console.log("lat: "+latU+"\nlong: "+longU+"\nprecision: "+accuracy);
            }
            };
        </script>
    </body>
</html>